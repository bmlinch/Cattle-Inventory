/*!
* js-data-firebase
* @version 2.1.1 - Homepage <http://wwwjs-data.io/docs/dsfirebaseadapter>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2015 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-firebase/blob/master/LICENSE>
*
* @overview Firebase adapter for js-data.
*/

!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b(require("js-data"),require("firebase")):"function"==typeof define&&define.amd?define(["js-data","firebase"],b):"object"==typeof exports?exports.DSFirebaseAdapter=b(require("js-data"),require("firebase")):a.DSFirebaseAdapter=b(a.JSData,a.Firebase)}(this,function(a,b){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){function d(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a){t.push(a)}function g(){t.length&&!u&&(u=!0,t[0]())}function h(a){t.length?f(a):(f(a),g())}function i(a){return new q.Promise(a).then(function(a){return u=!1,t.shift(),setTimeout(g,0),a},function(a){return u=!1,t.shift(),setTimeout(g,0),q.Promise.reject(a)})}var j=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),k=c(1),l=c(2),m=c(3),n=c(4),o=c(5),p=new k.DS,q=k.DSUtils,r=p.defaults.defaultFilter,s=function w(){e(this,w)};s.prototype.basePath="";var t=[],u=!1,v=function(){function a(b){e(this,a),b=b||{},this.defaults=new s,q.deepMixIn(this.defaults,b),this.ref=new l(b.basePath||this.defaults.basePath)}return j(a,[{key:"getRef",value:function(a,b){return b=b||{},this.ref.child(b.endpoint||a.endpoint)}},{key:"find",value:function(a,b,c){var e=this,f=void 0;return c=c||{},c["with"]=c["with"]||[],new q.Promise(function(d,f){e.getRef(a,c).child(b).once("value",function(c){var e=c.val();e?(e[a.idAttribute]=e[a.idAttribute]||b,d(e)):f(new Error("Not Found!"))},f,e)}).then(function(b){f=b;var g=[];return q.forEach(a.relationList,function(b){var h=b.relation,i=a.getResource(h),j=null;q.contains(c["with"],h)?j=h:q.contains(c["with"],b.localField)&&(j=b.localField),j&&!function(){var k=q.deepMixIn({},c.orig?c.orig():c);k["with"]=c["with"].slice(),k=q._(i,k),q.remove(k["with"],j),q.forEach(k["with"],function(a,b){a&&0===a.indexOf(j)&&a.length>=j.length&&"."===a[j.length]?k["with"][b]=a.substr(j.length+1):k["with"][b]=""});var l=void 0;if("hasOne"!==b.type&&"hasMany"!==b.type||!b.foreignKey)if("hasMany"===b.type&&b.localKeys){var m=[],n=f[b.localKeys]||[];n=Array.isArray(n)?n:q.keys(n),m=m.concat(n||[]),l=e.findAll(a.getResource(h),{where:d({},i.idAttribute,{"in":q.filter(o(m),function(a){return a})})},k).then(function(a){return q.set(f,b.localField,a),a})}else("belongsTo"===b.type||"hasOne"===b.type&&b.localKey)&&(l=e.find(a.getResource(h),q.get(f,b.localKey),k).then(function(a){return q.set(f,b.localField,a),a}));else l=e.findAll(a.getResource(h),{where:d({},b.foreignKey,{"==":f[a.idAttribute]})},k).then(function(a){return"hasOne"===b.type&&a.length?q.set(f,b.localField,a[0]):q.set(f,b.localField,a),a});l&&g.push(l)}()}),q.Promise.all(g)}).then(function(){return f})}},{key:"findAll",value:function(a,b,c){var e=this,f=null;return c=c||{},c["with"]=c["with"]||[],new q.Promise(function(d,f){e.getRef(a,c).once("value",function(e){var f=e.val();q.forOwn(f,function(b,c){b[a.idAttribute]||(b[a.idAttribute]="/"+c)}),d(r.call(p,m(f),a.name,b,c))},f,e)}).then(function(b){f=b;var g=[];return q.forEach(a.relationList,function(b){var h=b.relation,i=a.getResource(h),j=null;q.contains(c["with"],h)?j=h:q.contains(c["with"],b.localField)&&(j=b.localField),j&&!function(){var k=q.deepMixIn({},c.orig?c.orig():c);k["with"]=c["with"].slice(),k=q._(i,k),q.remove(k["with"],j),q.forEach(k["with"],function(a,b){a&&0===a.indexOf(j)&&a.length>=j.length&&"."===a[j.length]?k["with"][b]=a.substr(j.length+1):k["with"][b]=""});var l=void 0;"hasOne"!==b.type&&"hasMany"!==b.type||!b.foreignKey?"hasMany"===b.type&&b.localKeys?!function(){var c=[];q.forEach(f,function(a){var d=a[b.localKeys]||[];d=Array.isArray(d)?d:q.keys(d),c=c.concat(d||[])}),l=e.findAll(a.getResource(h),{where:d({},i.idAttribute,{"in":q.filter(o(c),function(a){return a})})},k).then(function(a){return q.forEach(f,function(c){var d=[],e=c[b.localKeys]||[];e=Array.isArray(e)?e:q.keys(e),q.forEach(a,function(a){e&&q.contains(e,a[i.idAttribute])&&d.push(a)}),q.set(c,b.localField,d)}),a})}():("belongsTo"===b.type||"hasOne"===b.type&&b.localKey)&&(l=e.findAll(a.getResource(h),{where:d({},i.idAttribute,{"in":q.filter(n(f,function(a){return q.get(a,b.localKey)}),function(a){return a})})},k).then(function(a){return q.forEach(f,function(c){q.forEach(a,function(a){a[i.idAttribute]===c[b.localKey]&&q.set(c,b.localField,a)})}),a})):l=e.findAll(a.getResource(h),{where:d({},b.foreignKey,{"in":q.filter(n(f,function(b){return q.get(b,a.idAttribute)}),function(a){return a})})},k).then(function(c){return q.forEach(f,function(d){var e=[];q.forEach(c,function(c){q.get(c,b.foreignKey)===d[a.idAttribute]&&e.push(c)}),"hasOne"===b.type&&e.length?q.set(d,b.localField,e[0]):q.set(d,b.localField,e)}),c}),l&&g.push(l)}()}),q.Promise.all(g)}).then(function(){return f})}},{key:"create",value:function(a,b,c){var d=this,e=b[a.idAttribute];return q.isString(e)||q.isNumber(e)?this.update(a,e,b,c):i(function(e,f){h(function(){var g=d.getRef(a,c),h=g.push(q.removeCircular(q.omit(b,a.relationFields||[])),function(b){if(b)return f(b);var c=h.toString().replace(g.toString(),"");h.child(a.idAttribute).set(c,function(a){a?f(a):h.once("value",function(a){try{e(a.val())}catch(b){f(b)}},f,d)})})})})}},{key:"update",value:function(a,b,c,d){var e=this;return i(function(f,g){h(function(){c=q.removeCircular(q.omit(c||{},a.relationFields||[]));var h=e.getRef(a,d).child(b);h.once("value",function(b){try{!function(){var d=b.val()||{},e=void 0,i=void 0,j=void 0;if(a.relations)for(e=a.relationFields,i=[],j=0;j<e.length;j++)i.push(c[e[j]]),delete c[e[j]];if(q.deepMixIn(d,c),a.relations)for(e=a.relationFields,j=0;j<e.length;j++){var k=i.shift();k&&(c[e[j]]=k)}h.set(d,function(a){a?g(a):f(d)})}()}catch(d){g(d)}},g,e)})})}},{key:"updateAll",value:function(a,b,c,d){var e=this;return this.findAll(a,c,d).then(function(c){var f=[];return q.forEach(c,function(c){f.push(e.update(a,c[a.idAttribute],b,d))}),q.Promise.all(f)})}},{key:"destroy",value:function(a,b,c){var d=this;return i(function(e,f){h(function(){d.getRef(a,c).child(b).remove(function(a){a?f(a):e()})})})}},{key:"destroyAll",value:function(a,b,c){var d=this;return this.findAll(a,b,c).then(function(b){var e=[];return q.forEach(b,function(b){e.push(d.destroy(a,b[a.idAttribute],c))}),q.Promise.all(e)})}}]),a}();a.exports=v},function(b,c,d){b.exports=a},function(a,c,d){a.exports=b},function(a,b,c){function d(a){var b=[];return e(a,function(a,c){b.push(a)}),b}var e=c(8);a.exports=d},function(a,b,c){function d(a,b,c){b=e(b,c);var d=[];if(null==a)return d;for(var f=-1,g=a.length;++f<g;)d[f]=b(a[f],f,a);return d}var e=c(6);a.exports=d},function(a,b,c){function d(a,b){return b=b||e,f(a,function(a,c,d){for(var e=d.length;++c<e;)if(b(a,d[c]))return!1;return!0})}function e(a,b){return a===b}var f=c(7);a.exports=d},function(a,b,c){function d(a,b){if(null==a)return e;switch(typeof a){case"function":return"undefined"!=typeof b?function(c,d,e){return a.call(b,c,d,e)}:a;case"object":return function(b){return g(b,a)};case"string":case"number":return f(a)}}var e=c(9),f=c(10),g=c(11);a.exports=d},function(a,b,c){function d(a,b,c){b=e(b,c);var d=[];if(null==a)return d;for(var f,g=-1,h=a.length;++g<h;)f=a[g],b(f,g,a)&&d.push(f);return d}var e=c(6);a.exports=d},function(a,b,c){function d(a,b,c){f(a,function(d,f){return e(a,f)?b.call(c,a[f],f,a):void 0})}var e=c(12),f=c(13);a.exports=d},function(a,b,c){function d(a){return a}a.exports=d},function(a,b,c){function d(a){return function(b){return b[a]}}a.exports=d},function(a,b,c){function d(a,b){for(var c=-1,d=a.length;++c<d;)if(g(a[c],b))return!0;return!1}function e(a,b){for(var c=-1,e=b.length;++c<e;)if(!d(a,b[c]))return!1;return!0}function f(a,b){var c=!0;return h(b,function(b,d){return g(a[d],b)?void 0:c=!1}),c}function g(a,b){return a&&"object"==typeof a?i(a)&&i(b)?e(a,b):f(a,b):a===b}var h=c(8),i=c(14);a.exports=g},function(a,b,c){function d(a,b){return Object.prototype.hasOwnProperty.call(a,b)}a.exports=d},function(a,b,c){function d(){h=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],g=!0;for(var a in{toString:null})g=!1}function e(a,b,c){var e,j=0;null==g&&d();for(e in a)if(f(b,a,e,c)===!1)break;if(g)for(var k=a.constructor,l=!!k&&a===k.prototype;(e=h[j++])&&("constructor"===e&&(l||!i(a,e))||a[e]===Object.prototype[e]||f(b,a,e,c)!==!1););}function f(a,b,c,d){return a.call(d,b[c],c,b)}var g,h,i=c(12);a.exports=e},function(a,b,c){var d=c(15),e=Array.isArray||function(a){return d(a,"Array")};a.exports=e},function(a,b,c){function d(a,b){return e(a)===b}var e=c(16);a.exports=d},function(a,b,c){function d(a){return null===a?"Null":a===e?"Undefined":f.exec(g.call(a))[1]}var e,f=/^\[object (.*)\]$/,g=Object.prototype.toString;a.exports=d}])});
//# sourceMappingURL=js-data-firebase.min.map